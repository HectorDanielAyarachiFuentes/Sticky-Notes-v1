<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Productividad | Impulsa tu Enfoque</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%235a7dcb' d='M83.2,16.8C75.1,8.7,66.2,2,50,2S24.9,8.7,16.8,16.8C8.7,24.9,2,33.8,2,50s6.7,25.1,14.8,33.2 c8.1,8.1,17,14.8,33.2,14.8s25.1-6.7,33.2-14.8C91.3,75.1,98,66.2,98,50S91.3,24.9,83.2,16.8z M72.2,38.1L57.5,52.8 c-2.5,2.5-5.8,3.7-9.2,3.7s-6.7-1.2-9.2-3.7L24.5,38.1c-1-1-1.5-2.2-1.5-3.5s0.5-2.5,1.5-3.5c2-2,5.1-2,7.1,0l12.4,12.4V22.2 c0-2.8,2.3-5.1,5.1-5.1s5.1,2.3,5.1,5.1v21.3l12.4-12.4c2-2,5.1-2,7.1,0C74.2,33,74.2,36.1,72.2,38.1z M68.5,75.7 c0,1.4-0.5,2.7-1.5,3.7c-2,2-5.1,2-7.1,0L50,69.5l-9.9,9.9c-2,2-5.1,2-7.1,0c-1-1-1.5-2.3-1.5-3.7c0-1.4,0.5-2.7,1.5-3.7L43,62.1 c2.5-2.5,5.8-3.7,9.2-3.7s6.7,1.2,9.2,3.7l9.9,9.9C68,73,68.5,74.3,68.5,75.7z'%3E%3C/path%3E%3C/svg%3E" type="image/svg+xml">
    
    <meta name="description" content="Organiza tus tareas, gestiona tu tiempo y aumenta tu enfoque con este dashboard de productividad personal. Incluye notas, zonas de trabajo, temporizador y mÃ¡s.">
    <meta name="author" content="Hector Daniel Ayarachi Fuentes">
    <meta name="theme-color" content="#5a7dcb"> 

    <style>
        :root {
            --bg-color: #f4f7f9;
            --note-color: #fffde7;
            --note-shadow: rgba(0, 0, 0, 0.1);
            --primary-accent: #5a7dcb;
            --primary-accent-dark: #405b9b;
            --panel-bg: rgba(255, 255, 255, 0.6);
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --zone-bg: rgba(90, 125, 203, 0.1);
            --zone-border: rgba(90, 125, 203, 0.4);
            --zone-highlight-bg: rgba(90, 125, 203, 0.2);
            --highlight-color: #ffc107;
            --danger-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-color); background-image: url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%23dce3eb" fill-opacity="0.4"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E'); margin: 0; padding: 0; overflow: hidden; height: 100vh; }
        .main-content { opacity: 0; transition: opacity 0.5s ease-in-out; }
        .logged-in .main-content { opacity: 1; }
        .logged-out .main-content { display: none; }
        #google-signin-btn { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 15px 30px; font-size: 18px; font-weight: 600; color: white; background-color: #DB4437; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 10000; }
        
        #app { position: relative; width: 100%; height: calc(100vh - 140px); padding: 20px; padding-top: 70px; box-sizing: border-box; }
        #top-controls { position: fixed; top: 15px; right: 20px; z-index: 1050; display: flex; gap: 12px; align-items: center; }
        #workspace-title { position: fixed; top: 20px; left: 20px; font-size: 24px; font-weight: 600; color: var(--text-dark); z-index: 1050; }
        
        .control-btn { padding: 10px 22px; font-size: 14px; font-weight: 600; color: white; background-color: var(--primary-accent); border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 5px 15px rgba(90, 125, 203, 0.3); transition: all 0.3s ease; }
        .control-btn:hover { background-color: var(--primary-accent-dark); transform: translateY(-2px); }
        .control-btn.secondary { background-color: #95a5a6; }
        
        .profile-menu-container { position: relative; }
        .profile-avatar { width: 45px; height: 45px; border-radius: 50%; cursor: pointer; border: 2px solid var(--panel-bg); box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: transform 0.2s ease; }
        .profile-dropdown { position: absolute; top: 120%; right: 0; width: 220px; background-color: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); padding: 15px; box-sizing: border-box; opacity: 0; visibility: hidden; transform: translateY(10px); transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); z-index: 1051; }
        .profile-menu-container:hover .profile-dropdown { opacity: 1; visibility: visible; transform: translateY(0); }
        .profile-dropdown .user-info { text-align: center; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0; margin-bottom: 10px; }
        .profile-dropdown .user-name { font-weight: 600; color: var(--text-dark); margin: 0; font-size: 16px; }
        .profile-dropdown .signout-btn { width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 10px; border: none; background-color: transparent; font-size: 14px; font-weight: 500; color: var(--danger-color); border-radius: 8px; cursor: pointer; transition: background-color 0.2s ease; }
        
        .draggable { position: absolute; z-index: 10; }
        .dragging { z-index: 999 !important; opacity: 0.8; }
        .note { width: 240px; height: 240px; background-color: var(--note-color); box-shadow: 0 8px 25px var(--note-shadow); border-radius: 8px; padding: 15px; box-sizing: border-box; cursor: move; display: flex; flex-direction: column; }
        .note textarea { flex-grow: 1; border: none; background: transparent; resize: none; font-family: 'Caveat', cursive; font-size: 22px; line-height: 1.5; color: var(--text-dark); outline: none; cursor: text; margin-top: 15px; }
        .zone { background-color: var(--zone-bg); border: 1px dashed var(--zone-border); border-radius: 12px; box-sizing: border-box; cursor: move; z-index: 1; padding: 45px 15px 15px 15px; min-width: 250px; min-height: 200px; transition: background-color 0.2s ease; }
        .zone.drop-target { background-color: var(--zone-highlight-bg); border-style: solid; }
        .zone-title { position: absolute; top: 12px; left: 15px; font-weight: 600; font-size: 16px; color: var(--primary-accent-dark); border: none; background: transparent; width: calc(100% - 60px); outline: none; }
        .delete-btn { position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; text-align: center; line-height: 24px; font-size: 20px; border-radius: 50%; cursor: pointer; transition: all 0.2s; color: var(--text-light); }
        .delete-btn:hover { background-color: var(--highlight-color); color: white; transform: scale(1.1); }
        .resize-handle { position: absolute; bottom: 0; right: 0; width: 20px; height: 20px; cursor: nwse-resize; z-index: 11; }
        
        #bottom-dashboard { position: fixed; bottom: 0; left: 0; width: 100%; height: 140px; background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); border-top: 1px solid rgba(255, 255, 255, 0.8); box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.05); display: flex; align-items: stretch; justify-content: space-between; padding: 0 15px; box-sizing: border-box; z-index: 1002; }
        .dashboard-widget { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-dark); padding: 10px; text-align: center; border-right: 1px solid rgba(0,0,0,0.05); flex-grow: 1; flex-basis: 0; }
        .dashboard-widget:last-child { border-right: none; }
        #stats-widget span, #clock-widget #current-time, #timer-display { font-size: 36px; font-weight: 600; }
        #calendar-widget { min-width: 280px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .day { cursor: pointer; border-radius: 50%; transition: background-color 0.2s; padding: 2px; }
        .day:hover { background-color: #e0e0e0; }
        .day.current-day { background-color: var(--highlight-color); color: white; }
        .day.selected-day { box-shadow: 0 0 0 2px var(--primary-accent); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 9999; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); text-align: center; max-width: 90%; width: 450px; transform: scale(0.9); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        
        #sidebar-toggle-btn { display: none; padding: 8px 12px; font-size: 18px; line-height: 1; }
        #mobile-sidebar-container { display: none; }
        
        @media (max-width: 768px) {
            body { overflow-y: auto; overflow-x: hidden; height: auto; }
            body.sidebar-active { overflow: hidden; }
            #bottom-dashboard { display: none !important; }
            #sidebar-toggle-btn { display: block; }
            #mobile-sidebar-container { display: block; }
            
            #top-controls { padding: 0 10px; width: auto; right: 10px; }
            .control-btn.secondary, #addZoneBtn, #addNoteBtn { display: none; }
            #workspace-title { left: 60px; top: 21px; font-size: 16px; max-width: calc(100% - 120px); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

            .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1099; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
            #mobile-sidebar { position: fixed; top: 0; left: -300px; width: 300px; max-width: 85%; height: 100%; background: #ffffff; z-index: 1100; box-shadow: 5px 0 15px rgba(0,0,0,0.1); transition: left 0.3s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column; }
            body.sidebar-active .sidebar-overlay { opacity: 1; visibility: visible; }
            body.sidebar-active #mobile-sidebar { left: 0; }
            .sidebar-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid #e0e0e0; }
            .sidebar-header h3 { margin: 0; font-size: 18px; }
            #close-sidebar-btn { background: none; border: none; font-size: 28px; cursor: pointer; color: var(--text-light); }
            .sidebar-content { overflow-y: auto; flex-grow: 1; }
            .sidebar-content .dashboard-widget { flex-direction: column; align-items: stretch; text-align: left; padding: 20px; border-bottom: 1px solid #eee; }
            .sidebar-content .calendar-grid { gap: 1px; }
            .sidebar-content .day { padding: 4px; }
            
            #app { display: flex; flex-direction: column; gap: 20px; padding: 80px 15px 20px 15px; height: auto; }
            #zones-container, #un-zoned-notes-container { display: contents; }
            .draggable, .note, .zone { position: static !important; left: auto !important; top: auto !important; width: 100% !important; height: auto !important; min-height: 0; transform: none !important; cursor: default !important; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
            .zone { padding: 15px; display: flex; flex-direction: column; gap: 10px; padding-top: 50px; background-color: white; border-style: solid; }
            .zone-title { font-size: 18px; width: calc(100% - 50px); }
            .notes-in-zone { display: flex; flex-direction: column; gap: 10px; position: relative; }
            .note { padding: 15px; min-height: 120px; }
            .note textarea { margin-top: 0; font-size: 16px; }
            .resize-handle { display: none !important; }
            .un-zoned-title { font-size: 16px; color: var(--text-light); margin-top: 20px; padding-bottom: 5px; border-bottom: 1px solid #ccc; }
        }
    </style>
</head>
<body class="logged-out">

    <button id="google-signin-btn">ð Iniciar SesiÃ³n con Google</button>

    <div class="main-content">
        <h2 id="workspace-title"></h2>
        <div id="top-controls">
            <button id="sidebar-toggle-btn" class="control-btn">â°</button>
            <span id="save-status"></span>
            <button id="show-general-btn" class="control-btn secondary">Tablero General</button>
            <button id="addZoneBtn" class="control-btn">AÃ±adir Zona</button>
            <button id="addNoteBtn" class="control-btn">AÃ±adir Nota</button>
            <div id="user-profile-menu" class="profile-menu-container">
                <img id="profile-avatar" src="" alt="Avatar de Usuario" class="profile-avatar">
                <div class="profile-dropdown">
                    <div class="user-info">
                        <p id="user-name" class="user-name"></p>
                    </div>
                    <button id="signout-btn" class="signout-btn"><span>ðª</span> Cerrar SesiÃ³n</button>
                </div>
            </div>
        </div>
        <div id="app"></div>
        
        <div id="bottom-dashboard">
            <div id="stats-widget" class="dashboard-widget"><h3>Notas</h3><span id="note-count">0</span></div>
            <div id="calendar-widget" class="dashboard-widget"><div class="calendar-header"><button id="prev-month"><</button><h3 id="month-year"></h3><button id="next-month">></button></div><div class="calendar-grid" id="calendar-days"></div></div>
            <div id="youtube-widget" class="dashboard-widget"><h3>MÃºsica</h3><input type="text" id="youtube-url-input" placeholder="Pega link de YouTube"><div id="youtube-player"></div></div>
            <div id="timer-widget" class="dashboard-widget"><h3>CronÃ³metro</h3><div class="timer-display-container"><span id="timer-display">25:00</span><button id="edit-timer-btn" title="Configurar">âï¸</button></div><div class="timer-buttons"><button id="start-timer">â¶</button><button id="stop-timer" class="hidden">ââ</button><button id="reset-timer">â²</button></div></div>
            <div id="clock-widget" class="dashboard-widget"><h3>Hora</h3><span id="current-time"></span><span id="current-date"></span></div>
        </div>
    </div>
    
    <div id="alert-modal-overlay" class="modal-overlay"></div>
    <div id="set-timer-modal-overlay" class="modal-overlay"></div>
    <div id="confirm-modal-overlay" class="modal-overlay"></div>

    <div id="mobile-sidebar-container">
        <div class="sidebar-overlay"></div>
        <aside id="mobile-sidebar">
            <div class="sidebar-header">
                <h3>Panel de Control</h3>
                <button id="close-sidebar-btn">Ã</button>
            </div>
            <div class="sidebar-content"></div>
        </aside>
    </div>

<audio id="alarm-sound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>    

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCptS0stYpYu5GGLNXgtjNJD8NFzKZdEj0",
        authDomain: "mi-dashboard-de-notas.firebaseapp.com",
        projectId: "mi-dashboard-de-notas",
        storageBucket: "mi-dashboard-de-notas.appspot.com",
        messagingSenderId: "829232928135",
        appId: "1:829232928135:web:04e2043af0d7f79d916f22",
        measurementId: "G-T89JSJ7DEN"
    };
    
    const App = {
        firebase: {},
        state: { currentUser: null, notes: [], zones: [], youtubeUrl: '', selectedDate: null, isDataLoaded: false, calendarDate: new Date(), timerInterval: null, timerSeconds: 1500, timerInitialDuration: 1500, pendingTimerAction: null },
        DOM: {},
        
        init() {
            this.cacheDOM();
            this.initFirebase();
            this.setupMobileUI();
            this.bindEvents();
            this.setupAllWidgets();
        },

        cacheDOM() {
            this.DOM.body = document.body;
            this.DOM.app = document.getElementById('app');
            this.DOM.signInBtn = document.getElementById('google-signin-btn');
            this.DOM.workspaceTitle = document.getElementById('workspace-title');
            this.DOM.addNoteBtn = document.getElementById('addNoteBtn');
            this.DOM.addZoneBtn = document.getElementById('addZoneBtn');
            this.DOM.showGeneralBtn = document.getElementById('show-general-btn');
            this.DOM.saveStatus = document.getElementById('save-status');
            this.DOM.profileAvatar = document.getElementById('profile-avatar');
            this.DOM.userName = document.getElementById('user-name');
            this.DOM.signOutBtn = document.getElementById('signout-btn');
            this.DOM.alarmSound = document.getElementById('alarm-sound');
            this.DOM.sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
            this.DOM.sidebarOverlay = document.querySelector('.sidebar-overlay');
            this.DOM.closeSidebarBtn = document.getElementById('close-sidebar-btn');
        },
        
        initFirebase() {
            const firebaseApp = initializeApp(firebaseConfig);
            this.firebase.auth = getAuth(firebaseApp);
            this.firebase.db = getFirestore(firebaseApp);
            this.firebase.provider = new GoogleAuthProvider();
            onAuthStateChanged(this.firebase.auth, user => {
                this.state.currentUser = user;
                if (user) {
                    this.DOM.body.classList.remove('logged-out');
                    this.DOM.body.classList.add('logged-in');
                    this.updateUserProfile(user);
                    this.loadData();
                } else {
                    this.DOM.body.classList.add('logged-out');
                    this.DOM.body.classList.remove('logged-in');
                    this.clearWorkspace();
                }
            });
        },
        
        setupMobileUI() {
            const sidebarContent = document.querySelector('#mobile-sidebar .sidebar-content');
            document.querySelectorAll('#bottom-dashboard .dashboard-widget').forEach(widget => {
                sidebarContent.appendChild(widget.cloneNode(true));
            });
        },

        bindEvents() {
            this.DOM.signInBtn.addEventListener('click', () => signInWithPopup(this.firebase.auth, this.firebase.provider).catch(console.error));
            this.DOM.signOutBtn.addEventListener('click', () => signOut(this.firebase.auth));
            this.DOM.addNoteBtn.addEventListener('click', () => this.addNote());
            this.DOM.addZoneBtn.addEventListener('click', () => this.addZone());
            this.DOM.showGeneralBtn.addEventListener('click', () => { this.state.selectedDate = null; this.renderAll(); this.closeSidebar(); });
            const toggleSidebar = () => this.DOM.body.classList.toggle('sidebar-active');
            this.DOM.sidebarToggleBtn.addEventListener('click', toggleSidebar);
            this.DOM.sidebarOverlay.addEventListener('click', toggleSidebar);
            this.DOM.closeSidebarBtn.addEventListener('click', toggleSidebar);
        },

        renderAll() { this.renderWorkspace(); this.renderCalendar(); this.updateStats(); },
        
        renderWorkspace() {
            this.DOM.app.innerHTML = '';
            const zonesToShow = this.state.zones.filter(z => z.date === this.state.selectedDate);
            const notesToShow = this.state.notes.filter(n => n.date === this.state.selectedDate);
            
            const zonesContainer = document.createElement('div');
            zonesContainer.id = 'zones-container';
            this.DOM.app.appendChild(zonesContainer);

            zonesToShow.forEach(zoneData => {
                const zoneEl = this.createZoneElement(zoneData);
                const notesInZoneContainer = zoneEl.querySelector('.notes-in-zone');
                const notesInThisZone = notesToShow.filter(n => n.zoneId === zoneData.id);
                notesInThisZone.forEach(noteData => {
                    const noteEl = this.createNoteElement(noteData);
                    notesInZoneContainer.appendChild(noteEl);
                });
                zonesContainer.appendChild(zoneEl);
            });

            const unZonedNotes = notesToShow.filter(n => !n.zoneId || !zonesToShow.some(z => z.id === n.zoneId));
            if (unZonedNotes.length > 0) {
                const unZonedContainer = document.createElement('div');
                unZonedContainer.id = 'un-zoned-notes-container';
                if (zonesToShow.length > 0) {
                    unZonedContainer.innerHTML = `<h3 class="un-zoned-title">Notas sin agrupar</h3>`;
                }
                unZonedNotes.forEach(noteData => {
                    const noteEl = this.createNoteElement(noteData);
                    unZonedContainer.appendChild(noteEl);
                });
                this.DOM.app.appendChild(unZonedContainer);
            }
            this.updateWorkspaceTitle();
        },

        createZoneElement(zoneData) {
            const element = document.createElement('div');
            element.className = 'draggable zone';
            element.dataset.id = zoneData.id;
            element.style.left = `${zoneData.x}px`; element.style.top = `${zoneData.y}px`;
            element.style.width = `${zoneData.width}px`; element.style.height = `${zoneData.height}px`;
            element.innerHTML = `<input class="zone-title" value="${zoneData.title}" placeholder="TÃ­tulo"><span class="delete-btn">Ã</span><div class="resize-handle"></div><div class="notes-in-zone"></div>`;
            element.querySelector('.zone-title').addEventListener('input', e => { zoneData.title = e.target.value; this.saveData(); });
            element.querySelector('.delete-btn').addEventListener('click', () => this.deleteZone(zoneData.id));
            this.makeDraggable(element, zoneData, false); this.makeResizable(element, zoneData);
            return element;
        },

        createNoteElement(noteData) {
            const element = document.createElement('div');
            element.className = 'draggable note';
            element.dataset.id = noteData.id;
            element.style.left = `${noteData.x}px`; element.style.top = `${noteData.y}px`;
            element.innerHTML = `<button class="delete-btn">Ã</button><textarea placeholder="Escribe algo...">${noteData.content}</textarea>`;
            element.querySelector('textarea').addEventListener('input', e => { noteData.content = e.target.value; this.saveData(); });
            element.querySelector('.delete-btn').addEventListener('click', () => this.deleteNote(noteData.id));
            this.makeDraggable(element, noteData, true);
            return element;
        },

        makeDraggable(element, item, isNote) {
            element.addEventListener('mousedown', e => {
                if (e.target.matches('textarea, input, .delete-btn, .resize-handle')) return;
                element.classList.add('dragging');
                document.querySelectorAll('.zone').forEach(z => z.classList.add('drop-target'));
                const offsetX = e.clientX - element.offsetLeft, offsetY = e.clientY - element.offsetTop;
                const onMouseMove = moveEvent => {
                    element.style.left = `${moveEvent.clientX - offsetX}px`;
                    element.style.top = `${moveEvent.clientY - offsetY}px`;
                };
                const onMouseUp = () => {
                    document.removeEventListener('mousemove', onMouseMove);
                    element.classList.remove('dragging');
                    document.querySelectorAll('.zone').forEach(z => z.classList.remove('drop-target'));
                    item.x = parseInt(element.style.left); item.y = parseInt(element.style.top);
                    if (isNote) this.assignNoteToZone(item, element);
                    this.saveData();
                };
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp, { once: true });
            });
        },

        makeResizable(element, item) { /* ... (LÃ³gica igual, sin cambios) ... */ },
        
        assignNoteToZone(note, noteEl) {
            const noteRect = noteEl.getBoundingClientRect();
            let newZoneId = null;
            let maxOverlap = 0;
            document.querySelectorAll('.zone').forEach(zoneEl => {
                const zoneRect = zoneEl.getBoundingClientRect();
                const overlapX = Math.max(0, Math.min(noteRect.right, zoneRect.right) - Math.max(noteRect.left, zoneRect.left));
                const overlapY = Math.max(0, Math.min(noteRect.bottom, zoneRect.bottom) - Math.max(noteRect.top, zoneRect.top));
                const overlapArea = overlapX * overlapY;
                if (overlapArea > maxOverlap) {
                    maxOverlap = overlapArea;
                    newZoneId = zoneEl.dataset.id;
                }
            });
            if (note.zoneId !== newZoneId) {
                note.zoneId = newZoneId;
                this.renderWorkspace();
            }
        },

        addNote() { this.state.notes.push({ id: Date.now(), content: '', x: 30, y: 80, date: this.state.selectedDate, zoneId: null }); this.renderAll(); this.saveData(); },
        addZone() { this.state.zones.push({ id: Date.now(), title: 'Nueva Zona', x: 50, y: 100, width: 400, height: 300, date: this.state.selectedDate }); this.renderAll(); this.saveData(); },
        deleteNote(id) { this.state.notes = this.state.notes.filter(n => n.id !== id); this.renderAll(); this.saveData(); },
        deleteZone(id) { this.state.zones = this.state.zones.filter(z => z.id !== id); this.state.notes.forEach(n => { if (n.zoneId === id) n.zoneId = null; }); this.renderAll(); this.saveData(); },
        
        updateUserProfile(user) { this.DOM.userName.textContent = user.displayName; this.DOM.profileAvatar.src = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName)}&background=random&color=fff`; },
        saveData: debounce(async function() { if (!this.state.currentUser) return; this.DOM.saveStatus.textContent = 'Guardando...'; try { await setDoc(doc(this.firebase.db, 'user_data', this.state.currentUser.uid), { notes: this.state.notes, zones: this.state.zones, youtubeUrl: this.state.youtubeUrl, selectedDate: this.state.selectedDate }); this.DOM.saveStatus.textContent = 'Guardado â'; setTimeout(() => this.DOM.saveStatus.textContent = '', 2000); } catch (e) { this.DOM.saveStatus.textContent = 'Error'; } }, 1500),
        async loadData() { const docSnap = await getDoc(doc(this.firebase.db, 'user_data', this.state.currentUser.uid)); if (docSnap.exists()) { const data = docSnap.data(); this.state.notes = data.notes || []; this.state.zones = data.zones || []; this.state.youtubeUrl = data.youtubeUrl || ''; this.state.selectedDate = data.selectedDate === undefined ? null : data.selectedDate; } else { this.state.notes = []; this.state.zones = []; this.state.youtubeUrl = ''; this.state.selectedDate = null; } this.state.isDataLoaded = true; this.renderAll(); this.setupAllYoutubePlayers(); },
        clearWorkspace() { this.DOM.app.innerHTML = ''; this.DOM.workspaceTitle.textContent = ''; this.state.isDataLoaded = false; },
        closeSidebar() { this.DOM.body.classList.remove('sidebar-active'); },
        updateWorkspaceTitle() { /* ... */ },
        updateStats() { const count = this.state.notes.filter(n => n.date === this.state.selectedDate).length; document.querySelectorAll('#stats-widget span').forEach(el => el.textContent = count); },
        
        setupAllWidgets() { document.querySelectorAll('.dashboard-widget').forEach(container => { if (container.id.includes('calendar')) this.setupCalendar(container); if (container.id.includes('youtube')) this.setupYoutubePlayer(container); if (container.id.includes('timer')) this.setupTimer(container); if (container.id.includes('clock')) this.setupClock(container); }); },
        setupCalendar(container) { /* ... */ },
        renderCalendar() { /* ... */ },
        setupAllYoutubePlayers() { document.querySelectorAll('#youtube-widget').forEach(c => this.setupYoutubePlayer(c)); },
        setupYoutubePlayer(container) { /* ... */ },
        setupTimer(container) { /* ... */ },
        updateTimerDisplay() { /* ... */ },
        startTimer() { /* ... */ },
        stopTimer() { /* ... */ },
        resetTimer() { /* ... */ },
        setupClock(container) { /* ... */ }
    };
    
    function debounce(func, wait) { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func.apply(this, args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; }
    document.addEventListener('DOMContentLoaded', () => App.init());
</script>

</body>
</html>